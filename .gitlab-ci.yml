---
image: registry.fi-ts.io/cloud-native/go-builder:latest

stages:
  - validate
  - test
  - deploy

sources:
  stage: validate
  script:
    - make golangci

.testdata-tpl:
  stage: validate
  image: ${OS_NAME}:${OS_VERSION}
  variables:
    FRR_FILES: "frr.conf.firewall frr.conf.machine"
    INTERFACES_FILES: "interfaces.firewall interfaces.machine"
    TESTDATA_DIR: "./internal/netconf/testdata"
  before_script:
    - apt-get update --quiet --quiet
    - apt-get install --yes docker.io
    - id=$(docker create metalstack/frr:7-${OS_NAME}-${OS_VERSION} --entrypoint top)
    - docker cp $id:artifacts .
    - docker rm -v $id
    - apt-get install --yes --no-install-recommends --quiet --quiet ifupdown2 ./artifacts/frr_*.deb ./artifacts/frr-pythontools_*.deb ./artifacts/libyang*.deb
  script:
    - ls -la ${TESTDATA_DIR}
    - for input in ${FRR_FILES}; do /bin/echo "${TESTDATA_DIR}/${input}"; vtysh --dryrun --inputfile "${TESTDATA_DIR}/${input}"; done
    - for input in ${INTERFACES_FILES}; do /bin/echo "${TESTDATA_DIR}/${input}"; ifup --syntax-check --all -i "${TESTDATA_DIR}/${input}" |grep -v syslog; done

testdata-ubuntu-19.10:
  extends: .testdata-tpl
  variables:
    OS_NAME: ubuntu
    OS_VERSION: "19.10"

testdata-ubuntu-20.04:
  extends: .testdata-tpl
  variables:
    OS_NAME: ubuntu
    OS_VERSION: "19.10"

testdata-debian-10:
  extends: .testdata-tpl
  variables:
    OS_NAME: debian
    OS_VERSION: "10"

unit-tests:
  stage: test
  script:
    - make test

.blobstore-tpl:
  stage: deploy
  script:
    - make
    - strip bin/metal-networker
    - tar -czvf metal-networker.tar.gz -C ./bin metal-networker -C ../internal/netconf/ interfaces.firewall.tpl interfaces.machine.tpl frr.machine.tpl frr.firewall.tpl rules.v4.tpl rules.v6.tpl systemd.link.tpl systemd.network.tpl hosts.tpl hostname.tpl droptailer.service.tpl firewall_policy_controller.service.tpl nftables_exporter.service.tpl node_exporter.service.tpl
    - curl -fLS https://dl.minio.io/client/mc/release/linux-amd64/mc -o /usr/local/bin/mc
    - chmod +x /usr/local/bin/mc
    - mc config host add fits https://blobstore.fi-ts.io $BLOB_ACCESS_KEY "${BLOB_SECRET_KEY}"
    - mc cp metal-networker.tar.gz fits/cloud-native/metal-networker-${suffix}.tar.gz

# This job is triggered only for a "stable" tagged branch to always have a version that is known to work properly.
stable:
  extends: .blobstore-tpl
  variables:
    suffix: stable
  only:
    - stable

# This job is triggered for every pipeline that runs in master branch to have bleeding edge version.
latest:
  extends: .blobstore-tpl
  variables:
    suffix: latest
  only:
    - master

# This job is triggered for every merge request.
mergerequest:
  extends: .blobstore-tpl
  variables:
    suffix: ${CI_COMMIT_REF_SLUG}
  only:
    - merge_requests